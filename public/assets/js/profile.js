// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyAU0CCiQNrPEYpTNU4rAwmOmPUZnjb2FoU",
  authDomain: "a-platform-for-learning.firebaseapp.com",
  projectId: "a-platform-for-learning",
  storageBucket: "a-platform-for-learning.firebasestorage.app",
  messagingSenderId: "764579707883",
  appId: "1:764579707883:web:5456e2348354cc58fab7ae",
  measurementId: "G-4P972FP416",
  databaseURL: "https://a-platform-for-learning-default-rtdb.firebaseio.com"
};

// Firebase variables
let app;
let auth;
let db;

// Initialize Firebase
function initFirebase() {
  if (window.firebase && window.firebase.app) {
    app = window.firebase.initializeApp(firebaseConfig);
    auth = window.firebase.auth(app);
    db = window.firebase.firestore(app);
    console.log('âœ… Firebase initialized');
    return true;
  }
  return false;
}

// Retry Firebase initialization
let retries = 0;
const firebaseInitInterval = setInterval(() => {
  if (initFirebase()) {
    clearInterval(firebaseInitInterval);
  } else if (retries++ > 10) {
    clearInterval(firebaseInitInterval);
    console.error('âŒ Firebase failed to load');
  }
}, 100);

// State
let currentUser = null;
let todos = [];

// Load todos from Firebase and auto-generate from new content
async function loadTodosFromFirebase() {
  if (!currentUser || !db) {
    console.log('âš ï¸ Cannot load todos: user or db not ready');
    return;
  }
  
  try {
    const userId = currentUser.uid;
    
    // Load user's manual todos from Firebase
    const todosRef = db.collection('todos');
    const todosQuery = todosRef.where('userId', '==', userId);
    const todosSnapshot = await todosQuery.get();
    
    todos = [];
    todosSnapshot.forEach(doc => {
      todos.push({ id: doc.id, ...doc.data() });
    });
    
    // Auto-generate todos from new content
    await generateAutomaticTodos();
    
    console.log('âœ… Loaded todos:', todos.length);
  } catch (error) {
    console.error('Error loading todos:', error);
  }
}

// Generate automatic todos from new content
async function generateAutomaticTodos() {
  if (!currentUser || !db) return;
  
  try {
    const userId = currentUser.uid;
    
    // Get user's watched videos
    const watchedVideosQuery = db.collection('videoWatches').where('userId', '==', userId);
    const watchedVideosSnapshot = await watchedVideosQuery.get();
    const watchedVideoIds = new Set();
    watchedVideosSnapshot.forEach(doc => {
      watchedVideoIds.add(doc.data().videoId);
    });
    
    // Get user's completed exams
    const completedExamsQuery = db.collection('examResults').where('userId', '==', userId);
    const completedExamsSnapshot = await completedExamsQuery.get();
    const completedExamIds = new Set();
    completedExamsSnapshot.forEach(doc => {
      completedExamIds.add(doc.data().examId);
    });
    
    // Get all videos
    const videosSnapshot = await db.collection('videos').get();
    const videos = [];
    videosSnapshot.forEach(doc => {
      const video = { id: doc.id, ...doc.data() };
      if (!watchedVideoIds.has(doc.id)) {
        videos.push(video);
      }
    });
    
    // Get all exams
    const examsSnapshot = await db.collection('exams').get();
    const exams = [];
    examsSnapshot.forEach(doc => {
      const exam = { id: doc.id, ...doc.data() };
      if (!completedExamIds.has(doc.id)) {
        exams.push(exam);
      }
    });
    
    // Get all materials
    const materialsSnapshot = await db.collection('materials').get();
    const materials = [];
    materialsSnapshot.forEach(doc => {
      materials.push({ id: doc.id, ...doc.data() });
    });
    
    // Get all notes
    const notesSnapshot = await db.collection('notes').get();
    const notes = [];
    notesSnapshot.forEach(doc => {
      notes.push({ id: doc.id, ...doc.data() });
    });
    
    // Add unwatched videos as todos (limit to 5 most recent)
    videos.slice(0, 5).forEach(video => {
      const existingTodo = todos.find(t => t.contentId === video.id && t.type === 'video');
      if (!existingTodo) {
        todos.push({
          id: `auto-video-${video.id}`,
          title: `Ø´Ø§Ù‡Ø¯: ${video.title}`,
          description: video.description || 'ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ Ø¬Ø¯ÙŠØ¯',
          completed: false,
          priority: 'medium',
          type: 'video',
          contentId: video.id,
          autoGenerated: true,
          createdAt: video.createdAt || new Date().toISOString()
        });
      }
    });
    
    // Add incomplete exams as todos (limit to 5 most recent)
    exams.slice(0, 5).forEach(exam => {
      const existingTodo = todos.find(t => t.contentId === exam.id && t.type === 'exam');
      if (!existingTodo) {
        todos.push({
          id: `auto-exam-${exam.id}`,
          title: `Ø­Ù„ Ø§Ù…ØªØ­Ø§Ù†: ${exam.title}`,
          description: exam.description || 'Ø§Ù…ØªØ­Ø§Ù† Ø¬Ø¯ÙŠØ¯ Ù…ØªØ§Ø­',
          completed: false,
          priority: 'high',
          type: 'exam',
          contentId: exam.id,
          autoGenerated: true,
          createdAt: exam.createdAt || new Date().toISOString()
        });
      }
    });
    
    // Add new materials as todos (limit to 3 most recent)
    materials.slice(0, 3).forEach(material => {
      const existingTodo = todos.find(t => t.contentId === material.id && t.type === 'material');
      if (!existingTodo) {
        todos.push({
          id: `auto-material-${material.id}`,
          title: `Ø±Ø§Ø¬Ø¹: ${material.title}`,
          description: material.description || 'Ù…Ø§Ø¯Ø© ØªØ¹Ù„ÙŠÙ…ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©',
          completed: false,
          priority: 'low',
          type: 'material',
          contentId: material.id,
          autoGenerated: true,
          createdAt: material.createdAt || new Date().toISOString()
        });
      }
    });
    
    // Add new notes as todos (limit to 3 most recent)
    notes.slice(0, 3).forEach(note => {
      const existingTodo = todos.find(t => t.contentId === note.id && t.type === 'note');
      if (!existingTodo) {
        todos.push({
          id: `auto-note-${note.id}`,
          title: `Ø§Ù‚Ø±Ø£: ${note.title}`,
          description: note.content ? note.content.substring(0, 100) : 'Ù…Ù„Ø§Ø­Ø¸Ø© Ø¬Ø¯ÙŠØ¯Ø©',
          completed: false,
          priority: 'low',
          type: 'note',
          contentId: note.id,
          autoGenerated: true,
          createdAt: note.createdAt || new Date().toISOString()
        });
      }
    });
    
    // Sort todos by priority and date
    todos.sort((a, b) => {
      const priorityOrder = { high: 0, medium: 1, low: 2 };
      if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
        return priorityOrder[a.priority] - priorityOrder[b.priority];
      }
      return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
    });
    
  } catch (error) {
    console.error('Error generating automatic todos:', error);
  }
}

// Utils
function generateInitials(name) {
  return name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  
  const icon = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸' }[type];
  
  toast.innerHTML = `
    <div class="toast-content">
      <span class="toast-icon">${icon}</span>
      <span class="toast-message">${message}</span>
      <button class="toast-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
    </div>
  `;
  
  if (!document.getElementById('toast-styles')) {
    const styles = document.createElement('style');
    styles.id = 'toast-styles';
    styles.textContent = `
      .toast {
        position: fixed; top: 20px; right: 20px;
        background: rgba(30, 41, 59, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 12px; padding: 1rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        z-index: 10000; animation: slideInRight 0.3s ease;
        max-width: 400px; border-left: 4px solid;
      }
      .toast-success { border-left-color: #10b981; }
      .toast-error { border-left-color: #ef4444; }
      .toast-info { border-left-color: #3b82f6; }
      .toast-content { display: flex; align-items: center; gap: 0.75rem; color: #f1f5f9; }
      .toast-icon { font-size: 1.2rem; flex-shrink: 0; }
      .toast-message { flex: 1; font-size: 0.95rem; }
      .toast-close {
        background: none; border: none; color: #94a3b8;
        font-size: 1.2rem; cursor: pointer; padding: 0;
        width: 24px; height: 24px; display: flex;
        align-items: center; justify-content: center;
        border-radius: 50%; transition: all 0.3s ease;
      }
      .toast-close:hover { background: rgba(148, 163, 184, 0.2); color: #f1f5f9; }
      @keyframes slideInRight {
        from { opacity: 0; transform: translateX(100%); }
        to { opacity: 1; transform: translateX(0); }
      }
    `;
    document.head.appendChild(styles);
  }
  
  document.body.appendChild(toast);
  setTimeout(() => {
    if (toast.parentElement) {
      toast.style.animation = 'slideInRight 0.3s ease reverse';
      setTimeout(() => toast.remove(), 300);
    }
  }, 3000);
}

function extractNameFromEmail(email) {
  const namePart = email.split('@')[0];
  return namePart
    .replace(/[._]/g, ' ')
    .split(' ')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
}

// UI Updates
function updateProfileUI(name, email) {
  if (!name || name.trim().length < 1) {
    name = extractNameFromEmail(email);
  }

  const attempts = [0, 50, 100, 200, 500];
  attempts.forEach(delay => {
    setTimeout(() => {
      const nameEl = document.getElementById('userName');
      const emailEl = document.getElementById('userEmail');
      const initialsEl = document.getElementById('userInitials');

      if (nameEl) nameEl.textContent = name;
      if (emailEl) emailEl.textContent = email;
      if (initialsEl) initialsEl.textContent = generateInitials(name);
    }, delay);
  });
}

// Auth
async function checkAuth() {
  return new Promise((resolve) => {
    const checkInterval = setInterval(() => {
      if (!auth) return;
      clearInterval(checkInterval);

      auth.onAuthStateChanged(async (user) => {
        if (!user) {
          const storedEmail = localStorage.getItem('currentUserEmail');
          const storedUser = localStorage.getItem('currentUser');
          
          if (storedEmail && storedUser) {
            try {
              const userData = JSON.parse(storedUser);
              const displayName = userData.name || extractNameFromEmail(storedEmail);
              
              currentUser = {
                uid: userData.uid || 'local-user',
                name: displayName,
                email: storedEmail,
                role: localStorage.getItem('userRole') || 'student',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
              };
              
              updateProfileUI(displayName, storedEmail);
              showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${displayName.split(' ')[0]}`, 'success');
              resolve();
              return;
            } catch (error) {
              console.error('Error parsing stored user:', error);
            }
          }
          
          showToast('ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error');
          setTimeout(() => window.location.href = '/public/pages/login.html', 2000);
          resolve();
          return;
        }

        try {
          const userRef = db.collection('users').doc(user.uid);
          const snap = await userRef.get();

          if (!snap.exists) {
            const displayName = user.displayName || extractNameFromEmail(user.email || '');
            const newUser = {
              uid: user.uid,
              name: displayName,
              email: user.email || '',
              role: 'student',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString(),
            };

            await userRef.set(newUser);
            currentUser = newUser;
          } else {
            currentUser = snap.data();
          }

          if (currentUser.role === 'teacher') {
            window.location.href = '/public/pages/dashboard.html';
            resolve();
            return;
          }

          updateProfileUI(currentUser.name, currentUser.email);
          showToast(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${currentUser.name.split(' ')[0]}`, 'success');
          resolve();

        } catch (err) {
          console.error('Auth error:', err);
          showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø©', 'error');
          resolve();
        }
      });
    }, 100);
  });
}

// Data Loading
async function loadProgress() {
  if (!currentUser) return;
  
  try {
    const userId = currentUser.uid;
    
    // Load total counts from Firebase
    const videosSnapshot = await db.collection('videos').get();
    const examsSnapshot = await db.collection('exams').get();
    
    const totalVideos = videosSnapshot.size;
    const totalExams = examsSnapshot.size;
    
    // Load user's completed videos
    const videoWatchesQuery = db.collection('videoWatches').where('userId', '==', userId);
    const videoWatchesSnapshot = await videoWatchesQuery.get();
    const completedVideos = videoWatchesSnapshot.size;
    
    // Load user's passed exams
    const examResultsQuery = db.collection('examResults')
      .where('userId', '==', userId)
      .where('passed', '==', true);
    const examResultsSnapshot = await examResultsQuery.get();
    const passedExams = examResultsSnapshot.size;
    
    // Count active todos
    const activeTodos = todos.filter(t => !t.completed).length;
    
    const elements = {
      completedVideos: document.getElementById('completedVideos'),
      completedExams: document.getElementById('completedExams'),
      totalVideosCount: document.getElementById('totalVideosCount'),
      totalExamsCount: document.getElementById('totalExamsCount'),
      watchedVideos: document.getElementById('watchedVideos'),
      passedExams: document.getElementById('passedExams'),
      totalTodos: document.getElementById('totalTodos'),
      videoProgress: document.getElementById('videoProgress'),
      examProgress: document.getElementById('examProgress'),
      videoProgressBar: document.getElementById('videoProgressBar'),
      examProgressBar: document.getElementById('examProgressBar')
    };
    
    if (elements.completedVideos) elements.completedVideos.textContent = completedVideos.toString();
    if (elements.completedExams) elements.completedExams.textContent = passedExams.toString();
    if (elements.totalVideosCount) elements.totalVideosCount.textContent = totalVideos.toString();
    if (elements.totalExamsCount) elements.totalExamsCount.textContent = totalExams.toString();
    if (elements.watchedVideos) elements.watchedVideos.textContent = completedVideos.toString();
    if (elements.passedExams) elements.passedExams.textContent = passedExams.toString();
    if (elements.totalTodos) elements.totalTodos.textContent = activeTodos.toString();
    
    const videoProgress = totalVideos > 0 ? Math.round((completedVideos / totalVideos) * 100) : 0;
    const examProgress = totalExams > 0 ? Math.round((passedExams / totalExams) * 100) : 0;
    
    if (elements.videoProgress) elements.videoProgress.textContent = videoProgress + '%';
    if (elements.examProgress) elements.examProgress.textContent = examProgress + '%';
    
    if (elements.videoProgressBar) elements.videoProgressBar.style.width = videoProgress + '%';
    if (elements.examProgressBar) elements.examProgressBar.style.width = examProgress + '%';
    
    console.log('âœ… Progress loaded:', { completedVideos, totalVideos, passedExams, totalExams });
  } catch (error) {
    console.error('Error loading progress:', error);
    // Fallback to showing zeros if error
    const elements = {
      completedVideos: document.getElementById('completedVideos'),
      completedExams: document.getElementById('completedExams'),
      totalVideosCount: document.getElementById('totalVideosCount'),
      totalExamsCount: document.getElementById('totalExamsCount'),
      watchedVideos: document.getElementById('watchedVideos'),
      passedExams: document.getElementById('passedExams'),
      totalTodos: document.getElementById('totalTodos'),
      videoProgress: document.getElementById('videoProgress'),
      examProgress: document.getElementById('examProgress'),
      videoProgressBar: document.getElementById('videoProgressBar'),
      examProgressBar: document.getElementById('examProgressBar')
    };
    
    if (elements.completedVideos) elements.completedVideos.textContent = '0';
    if (elements.completedExams) elements.completedExams.textContent = '0';
    if (elements.totalVideosCount) elements.totalVideosCount.textContent = '0';
    if (elements.totalExamsCount) elements.totalExamsCount.textContent = '0';
    if (elements.watchedVideos) elements.watchedVideos.textContent = '0';
    if (elements.passedExams) elements.passedExams.textContent = '0';
    if (elements.totalTodos) elements.totalTodos.textContent = '0';
    if (elements.videoProgress) elements.videoProgress.textContent = '0%';
    if (elements.examProgress) elements.examProgress.textContent = '0%';
    if (elements.videoProgressBar) elements.videoProgressBar.style.width = '0%';
    if (elements.examProgressBar) elements.examProgressBar.style.width = '0%';
  }
}

function loadTodos() {
  const todoList = document.getElementById('todoList');
  if (!todoList) return;
  
  // Get active filter
  const activeFilter = document.querySelector('.filter-btn.active');
  const filter = activeFilter ? activeFilter.getAttribute('data-filter') : 'all';
  
  // Filter todos
  let filteredTodos = todos;
  if (filter === 'pending') {
    filteredTodos = todos.filter(t => !t.completed);
  } else if (filter === 'completed') {
    filteredTodos = todos.filter(t => t.completed);
  }
  
  todoList.innerHTML = '';
  
  if (filteredTodos.length === 0) {
    todoList.innerHTML = `
      <div style="text-align: center; padding: 3rem; color: #94a3b8;">
        <div style="font-size: 3rem; margin-bottom: 1rem;">âœ…</div>
        <p>${filter === 'completed' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù… Ù…ÙƒØªÙ…Ù„Ø©' : 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‡Ø§Ù…'}</p>
      </div>
    `;
    return;
  }
  
  filteredTodos.forEach(todo => {
    const todoElement = document.createElement('div');
    todoElement.className = `todo-item ${todo.completed ? 'completed' : ''} priority-${todo.priority}`;
    
    const priorityLabels = { high: 'Ø¹Ø§Ù„ÙŠØ©', medium: 'Ù…ØªÙˆØ³Ø·Ø©', low: 'Ù…Ù†Ø®ÙØ¶Ø©' };
    const typeIcons = { video: 'ğŸ¥', exam: 'ğŸ“', material: 'ğŸ“š', note: 'ğŸ“‹', manual: 'âœï¸' };
    const typeIcon = typeIcons[todo.type] || 'âœï¸';
    
    // Create action button based on type
    let actionButton = '';
    if (todo.type === 'video' && !todo.completed) {
      actionButton = `<button class="btn-action" data-action="watch" data-id="${todo.contentId}">Ø´Ø§Ù‡Ø¯ Ø§Ù„Ø¢Ù†</button>`;
    } else if (todo.type === 'exam' && !todo.completed) {
      actionButton = `<button class="btn-action" data-action="solve" data-id="${todo.contentId}">Ø­Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†</button>`;
    } else if (todo.type === 'material' && !todo.completed) {
      actionButton = `<button class="btn-action" data-action="view" data-id="${todo.contentId}">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø§Ø¯Ø©</button>`;
    } else if (todo.type === 'note' && !todo.completed) {
      actionButton = `<button class="btn-action" data-action="read" data-id="${todo.contentId}">Ø§Ù‚Ø±Ø£ Ø§Ù„Ø¢Ù†</button>`;
    }
    
    todoElement.innerHTML = `
      <div class="todo-checkbox">
        <input type="checkbox" ${todo.completed ? 'checked' : ''} data-id="${todo.id}">
      </div>
      <div class="todo-content">
        <h4 class="todo-title">${typeIcon} ${todo.title}</h4>
        ${todo.description ? `<p class="todo-description">${todo.description}</p>` : ''}
        <div class="todo-meta">
          <span class="todo-priority ${todo.priority}">${priorityLabels[todo.priority]}</span>
          ${todo.dueDate ? `<span class="todo-due">ğŸ“… ${todo.dueDate}</span>` : ''}
          ${todo.autoGenerated ? '<span class="todo-badge">ØªÙ„Ù‚Ø§Ø¦ÙŠ</span>' : ''}
        </div>
        ${actionButton}
      </div>
      <div class="todo-actions">
        ${!todo.autoGenerated ? `<button class="btn-icon delete-todo" data-id="${todo.id}" title="Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©">ğŸ—‘ï¸</button>` : ''}
      </div>
    `;
    
    todoList.appendChild(todoElement);
  });
  
  // Update active todos count
  const activeTodos = todos.filter(t => !t.completed).length;
  const totalTodosEl = document.getElementById('totalTodos');
  if (totalTodosEl) {
    totalTodosEl.textContent = activeTodos.toString();
  }
}

async function loadExamResults() {
  const container = document.getElementById('examResults');
  if (!container) return;
  
  try {
    const user = auth.currentUser;
    if (!user && !currentUser) {
      console.log('No user logged in');
      container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94a3b8;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>
          <p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø­Ù„ Ø£ÙŠ Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯</p>
        </div>
      `;
      return;
    }
    
    const userId = user ? user.uid : currentUser.uid;
    console.log('Loading exam results for user:', userId);
    
    // ØªØ­Ù…ÙŠÙ„ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ù…Ù† Firebase
    const resultsRef = db.collection('examResults');
    const resultsQuery = resultsRef.where('userId', '==', userId);
    const resultsSnapshot = await resultsQuery.get();
    
    console.log('Exam results found:', resultsSnapshot.size);
    
    if (resultsSnapshot.empty) {
      container.innerHTML = `
        <div style="grid-column: 1/-1; text-align: center; padding: 3rem; color: #94a3b8;">
          <div style="font-size: 3rem; margin-bottom: 1rem;">ğŸ“Š</div>
          <p>Ù„Ù… ØªÙ‚Ù… Ø¨Ø­Ù„ Ø£ÙŠ Ø§Ù…ØªØ­Ø§Ù† Ø¨Ø¹Ø¯</p>
        </div>
      `;
      return;
    }
    
    container.innerHTML = '';
    
    // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
    const results = [];
    resultsSnapshot.forEach(doc => {
      results.push({ id: doc.id, ...doc.data() });
    });
    results.sort((a, b) => new Date(b.completedAt) - new Date(a.completedAt));
    
    results.forEach(result => {
      const percentage = Math.round(result.score);
      const passed = result.passed;
      
      const resultElement = document.createElement('div');
      resultElement.className = `result-item ${passed ? 'passed' : 'failed'}`;
      
      const date = new Date(result.completedAt).toLocaleDateString('ar-EG', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      resultElement.innerHTML = `
        <div class="result-info">
          <h4>ğŸ“ ${result.examTitle}</h4>
          <p>ğŸ“… ${date}</p>
        </div>
        <div class="result-score">
          <span class="score-value">${percentage}%</span>
          <span class="score-label">${result.correctAnswers}/${result.totalQuestions}</span>
        </div>
        <div class="result-status">
          <span class="${passed ? 'badge-success' : 'badge-danger'}">
            ${passed ? 'âœ… Ù†Ø§Ø¬Ø­' : 'âŒ Ø±Ø§Ø³Ø¨'}
          </span>
        </div>
      `;
      
      container.appendChild(resultElement);
    });
    
  } catch (error) {
    console.error('Error loading exam results:', error);
    container.innerHTML = `
      <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #f87171;">
        <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬: ${error.message}</p>
      </div>
    `;
  }
}

async function loadAchievements() {
  const container = document.getElementById('achievementsList');
  if (!container) return;
  
  try {
    const userId = currentUser.uid;
    
    // Get real statistics
    const videoWatchesSnapshot = await db.collection('videoWatches')
      .where('userId', '==', userId).get();
    const watchedVideosCount = videoWatchesSnapshot.size;
    
    const examResultsSnapshot = await db.collection('examResults')
      .where('userId', '==', userId)
      .where('passed', '==', true).get();
    const passedExamsCount = examResultsSnapshot.size;
    
    // Define achievements based on real progress
    const achievements = [
      { 
        title: 'Ø£ÙˆÙ„ Ø®Ø·ÙˆØ©', 
        description: 'Ø´Ø§Ù‡Ø¯ Ø£ÙˆÙ„ ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ', 
        icon: 'ğŸ¬', 
        unlocked: watchedVideosCount >= 1, 
        progress: Math.min(100, watchedVideosCount * 100) 
      },
      { 
        title: 'Ø®Ø¨ÙŠØ± Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø©', 
        description: 'Ø´Ø§Ù‡Ø¯ 10 ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª ØªØ¹Ù„ÙŠÙ…ÙŠØ©', 
        icon: 'ğŸ†', 
        unlocked: watchedVideosCount >= 10, 
        progress: Math.min(100, (watchedVideosCount / 10) * 100) 
      },
      { 
        title: 'Ø£ÙˆÙ„ Ø§Ù…ØªØ­Ø§Ù†', 
        description: 'Ø§Ø¬ØªØ² Ø£ÙˆÙ„ Ø§Ù…ØªØ­Ø§Ù† Ø¨Ù†Ø¬Ø§Ø­', 
        icon: 'ğŸ“', 
        unlocked: passedExamsCount >= 1, 
        progress: Math.min(100, passedExamsCount * 100) 
      },
      { 
        title: 'Ù…ØªÙÙˆÙ‚', 
        description: 'Ø§Ø¬ØªØ² 5 Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 
        icon: 'ğŸŒŸ', 
        unlocked: passedExamsCount >= 5, 
        progress: Math.min(100, (passedExamsCount / 5) * 100) 
      },
      { 
        title: 'Ø¹Ø§Ø´Ù‚ Ø§Ù„ØªØ¹Ù„Ù…', 
        description: 'Ø´Ø§Ù‡Ø¯ 25 ÙÙŠØ¯ÙŠÙˆ ØªØ¹Ù„ÙŠÙ…ÙŠ', 
        icon: 'ğŸ’', 
        unlocked: watchedVideosCount >= 25, 
        progress: Math.min(100, (watchedVideosCount / 25) * 100) 
      },
      { 
        title: 'Ø¨Ø·Ù„ Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†Ø§Øª', 
        description: 'Ø§Ø¬ØªØ² 10 Ø§Ù…ØªØ­Ø§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­', 
        icon: 'ğŸ‘‘', 
        unlocked: passedExamsCount >= 10, 
        progress: Math.min(100, (passedExamsCount / 10) * 100) 
      }
    ];
    
    container.innerHTML = '';
    
    achievements.forEach(achievement => {
      const card = document.createElement('div');
      card.className = `achievement-card ${achievement.unlocked ? 'unlocked' : 'locked'}`;
      
      card.innerHTML = `
        <div class="achievement-icon ${achievement.unlocked ? 'unlocked' : 'locked'}">
          ${achievement.unlocked ? achievement.icon : 'ğŸ”’'}
        </div>
        <h3 class="achievement-title">${achievement.title}</h3>
        <p class="achievement-description">${achievement.description}</p>
        <div class="achievement-progress">
          <div class="progress-bar">
            <div class="progress-fill" style="width: ${Math.round(achievement.progress)}%"></div>
          </div>
          <span class="progress-text">${Math.round(achievement.progress)}%</span>
        </div>
        ${achievement.unlocked ? '<div class="achievement-badge">Ù…ÙƒØªÙ…Ù„</div>' : ''}
      `;
      
      container.appendChild(card);
    });
  } catch (error) {
    console.error('Error loading achievements:', error);
    container.innerHTML = `
      <div style="grid-column: 1/-1; text-align: center; padding: 2rem; color: #f87171;">
        <p>Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ù†Ø¬Ø§Ø²Ø§Øª</p>
      </div>
    `;
  }
}

// Add Todo Modal
function showAddTodoModal() {
  const modal = document.createElement('div');
  modal.className = 'modal active';
  modal.innerHTML = `
    <div class="modal-overlay"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h2>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù‡Ù…Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <button class="modal-close">Ã—</button>
      </div>
      <form id="addTodoForm">
        <div class="form-group">
          <label>Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø© *</label>
          <input type="text" id="todoTitle" required placeholder="Ù…Ø«Ø§Ù„: Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø¯Ø±Ø³ Ø§Ù„Ø£ÙˆÙ„">
        </div>
        <div class="form-group">
          <label>ÙˆØµÙ Ø§Ù„Ù…Ù‡Ù…Ø©</label>
          <textarea id="todoDescription" placeholder="ØªÙØ§ØµÙŠÙ„ Ø¥Ø¶Ø§ÙÙŠØ© Ø¹Ù† Ø§Ù„Ù…Ù‡Ù…Ø©..."></textarea>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©</label>
            <select id="todoPriority">
              <option value="low">ğŸŸ¢ Ù…Ù†Ø®ÙØ¶Ø©</option>
              <option value="medium" selected>ğŸŸ¡ Ù…ØªÙˆØ³Ø·Ø©</option>
              <option value="high">ğŸ”´ Ø¹Ø§Ù„ÙŠØ©</option>
            </select>
          </div>
          <div class="form-group">
            <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªØ­Ù‚Ø§Ù‚</label>
            <input type="date" id="todoDueDate">
          </div>
        </div>
        <div class="form-actions">
          <button type="submit" class="btn btn-primary">âœ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          <button type="button" class="btn btn-secondary close-modal">âŒ Ø¥Ù„ØºØ§Ø¡</button>
        </div>
      </form>
    </div>
  `;
  
  if (!document.getElementById('modal-styles')) {
    const styles = document.createElement('style');
    styles.id = 'modal-styles';
    styles.textContent = `
      .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10000; display: flex; align-items: center; justify-content: center; }
      .modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
      .modal-content { background: #1e293b; border-radius: 12px; padding: 2rem; max-width: 500px; width: 90%; position: relative; }
      .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
      .modal-header h2 { color: #f1f5f9; margin: 0; }
      .modal-close { background: none; border: none; color: #94a3b8; font-size: 1.5rem; cursor: pointer; }
      .form-group { margin-bottom: 1rem; }
      .form-group label { display: block; color: #f1f5f9; margin-bottom: 0.5rem; }
      .form-group input, .form-group textarea, .form-group select {
        width: 100%; padding: 0.75rem; border: 1px solid #475569; border-radius: 8px;
        background: #334155; color: #f1f5f9; font-family: inherit;
      }
      .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
      .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
      .btn { padding: 0.75rem 1.5rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 500; }
      .btn-primary { background: #3b82f6; color: white; }
      .btn-secondary { background: #6b7280; color: white; }
    `;
    document.head.appendChild(styles);
  }
  
  document.body.appendChild(modal);
  
  const form = modal.querySelector('#addTodoForm');
  const closeBtn = modal.querySelector('.modal-close');
  const cancelBtn = modal.querySelector('.close-modal');
  const overlay = modal.querySelector('.modal-overlay');
  
  const closeModal = () => modal.remove();
  
  form.addEventListener('submit', (e) => {
    e.preventDefault();
    
    const title = document.getElementById('todoTitle').value.trim();
    const description = document.getElementById('todoDescription').value.trim();
    const priority = document.getElementById('todoPriority').value;
    const dueDate = document.getElementById('todoDueDate').value;
    
    if (!title) {
      showToast('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù‡Ù…Ø©', 'error');
      return;
    }
    
    const newTodo = {
      id: Date.now().toString(),
      title,
      description: description || undefined,
      completed: false,
      priority,
      dueDate: dueDate || undefined
    };
    
    todos.push(newTodo);
    loadTodos();
    closeModal();
    showToast('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù‡Ù…Ø© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
  });
  
  closeBtn.addEventListener('click', closeModal);
  cancelBtn.addEventListener('click', closeModal);
  overlay.addEventListener('click', closeModal);
  
  setTimeout(() => {
    document.getElementById('todoTitle').focus();
  }, 100);
}

// Tab Management
function switchTab(tabName) {
  const tabButtons = document.querySelectorAll('.tab-btn');
  const tabContents = document.querySelectorAll('.tab-content');
  
  tabButtons.forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-tab') === tabName) {
      btn.classList.add('active');
    }
  });
  
  tabContents.forEach(content => {
    content.classList.remove('active');
    if (content.id === tabName + 'Tab') {
      content.classList.add('active');
    }
  });
  
  if (tabName === 'todos') {
    loadTodosFromFirebase().then(() => loadTodos());
  } else if (tabName === 'results') {
    loadExamResults();
  } else if (tabName === 'achievements') {
    loadAchievements();
  }
}

// Event Listeners
function initializeEventListeners() {
  const tabButtons = document.querySelectorAll('.tab-btn');
  tabButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const tabName = btn.getAttribute('data-tab');
      if (tabName) switchTab(tabName);
    });
  });
  
  const filterButtons = document.querySelectorAll('.filter-btn');
  filterButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      filterButtons.forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadTodos();
    });
  });
  
  const addTodoBtn = document.getElementById('addTodoBtn');
  if (addTodoBtn) {
    addTodoBtn.addEventListener('click', () => {
      showAddTodoModal();
    });
  }
  
  document.addEventListener('click', (e) => {
    const target = e.target;
    
    // Handle checkbox toggle
    if (target.type === 'checkbox' && target.dataset.id) {
      const todoItem = target.closest('.todo-item');
      const todoId = target.dataset.id;
      if (todoItem && todoId) {
        const todo = todos.find(t => t.id === todoId);
        if (todo) {
          todo.completed = target.checked;
          todoItem.classList.toggle('completed', todo.completed);
          
          // If auto-generated todo is completed, mark content as done
          if (todo.completed && todo.autoGenerated) {
            markContentAsCompleted(todo.type, todo.contentId);
          }
          
          showToast(todo.completed ? 'âœ… ØªÙ… Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©!' : 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥ÙƒÙ…Ø§Ù„ Ø§Ù„Ù…Ù‡Ù…Ø©', 'success');
          loadTodos(); // Refresh to update count
        }
      }
    }
    
    // Handle delete todo
    if (target.classList.contains('delete-todo')) {
      const todoItem = target.closest('.todo-item');
      const todoId = target.dataset.id;
      if (todoItem && todoId) {
        todos = todos.filter(todo => todo.id !== todoId);
        todoItem.remove();
        showToast('ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù‡Ù…Ø©', 'success');
        loadTodos(); // Refresh to update count
      }
    }
    
    // Handle action buttons
    if (target.classList.contains('btn-action')) {
      const action = target.getAttribute('data-action');
      const contentId = target.getAttribute('data-id');
      
      if (action === 'watch') {
        window.location.href = `/public/pages/video-player.html?id=${contentId}`;
      } else if (action === 'solve') {
        window.location.href = `/public/pages/exam-player.html?id=${contentId}`;
      } else if (action === 'view') {
        window.location.href = `/public/pages/materials.html#${contentId}`;
      } else if (action === 'read') {
        window.location.href = `/public/pages/notes.html#${contentId}`;
      }
    }
  });
}

// Mark content as completed in Firebase
async function markContentAsCompleted(type, contentId) {
  if (!currentUser || !db) return;
  
  try {
    const userId = currentUser.uid;
    
    if (type === 'video') {
      // Add to videoWatches collection
      const watchRef = db.collection('videoWatches');
      await watchRef.add({
        userId,
        videoId: contentId,
        watchedAt: new Date().toISOString()
      });
      console.log('âœ… Video marked as watched');
    }
    
    // Reload todos to remove completed auto-generated ones
    setTimeout(() => {
      loadTodosFromFirebase().then(() => loadTodos());
    }, 1000);
    
  } catch (error) {
    console.error('Error marking content as completed:', error);
  }
}

// Initialization
document.addEventListener('DOMContentLoaded', async () => {
  console.log('ğŸš€ Profile page loading...');
  
  try {
    await checkAuth();
    
    if (currentUser) {
      console.log('âœ… User authenticated:', currentUser.name);
      await loadProgress();
      initializeEventListeners();
      switchTab('todos');
      console.log('ğŸ‰ Profile page initialized successfully');
    }
  } catch (error) {
    console.error('âŒ Error initializing profile:', error);
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©', 'error');
  }
});